name: AI Workflow Failure Analyzer

on:
  workflow_run:
    workflows: ["Gemini PR Code Review"] # ★監視したいワークフロー名を設定
    types:
      - completed

jobs:
  analyze_failure:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write
      actions: read

    steps:
    - name: コードのチェックアウト
      uses: actions/checkout@v4

    - name: Pythonのセットアップ
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: 依存関係のインストール
      run: |
        pip install requests google-generativeai PyGithub
        pip install jq

    - name: 失敗したジョブの詳細を取得し、分析を実行
      id: analyze_step # ★このステップにIDを追加★
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        GEMINI_ACCESS_TOKEN: ${{ secrets.GEMINI_ACCESS_TOKEN }}
        # ★ファイルに書き出す代わりに、必要な情報を個別に環境変数として渡す★
        FAILED_WORKFLOW_RUN_ID: ${{ github.event.workflow_run.id }}
        FAILED_WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
        FAILED_WORKFLOW_RUN_URL: ${{ github.event.workflow_run.html_url }}
        # GitHub Eventの pull_requests 配列も直接渡す (JSON文字列として)
        # これがエラーの原因だったので、これをシェルが直接処理しないようにする
        GITHUB_PULL_REQUESTS_JSON: ${{ toJSON(github.event.workflow_run.pull_requests) }} 

      run: |
        set -e

        echo "ワークフロー実行ID ${{ env.FAILED_WORKFLOW_RUN_ID }} の失敗したジョブIDを探しています。"

        JOB_DATA=$(curl -s \
                     -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                     -H "Accept: application/vnd.github.v3+json" \
                     "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ env.FAILED_WORKFLOW_RUN_ID }}/jobs")

        FAILED_JOB_ID=$(echo "$JOB_DATA" | jq -r '.jobs[] | select(.conclusion == "failure") | .id' | head -n 1)
        FAILED_JOB_NAME=$(echo "$JOB_DATA" | jq -r '.jobs[] | select(.conclusion == "failure") | .name' | head -n 1)

        if [ -z "$FAILED_JOB_ID" ]; then
          echo "分析対象の失敗したジョブが見つかりませんでした。"
          exit 0
        fi

        echo "失敗したジョブID: $FAILED_JOB_ID (名前: $FAILED_JOB_NAME) を検出しました。"
        
        # ★ここから修正★ Pythonスクリプトに引数として直接渡す
        # 環境変数として渡すと、シェルがJSONを扱ってエラーになる可能性があったため
        python analyze_log.py \
          "${{ env.FAILED_WORKFLOW_NAME }}" \
          "${{ env.FAILED_WORKFLOW_RUN_ID }}" \
          "${{ env.FAILED_JOB_ID }}" \
          "${{ env.FAILED_JOB_NAME }}" \
          "${{ env.FAILED_WORKFLOW_RUN_URL }}" \
          "${{ env.GITHUB_PULL_REQUESTS_JSON }}" # PR情報も文字列として渡す