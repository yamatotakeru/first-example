import os
import requests
import json
import google.generativeai as genai
from google.api_core.exceptions import ResourceExhausted, GoogleAPICallError

# ç’°å¢ƒå¤‰æ•°ã‹ã‚‰Secretsã‚’èª­ã¿è¾¼ã‚€
GEMINI_API_KEY = os.environ.get("GOOGLE_API_KEY")
# GitHubã®Personal Access Token (PAT)
# YAMLãƒ•ã‚¡ã‚¤ãƒ«ã§è¨­å®šã—ãŸ secrets.GEMINI_ACCESS_TOKEN ã‚’èª­ã¿è¾¼ã‚€
GITHUB_TOKEN = os.environ.get("GEMINI_ACCESS_TOKEN")

# ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ã¨ã™ã‚‹å·®åˆ†ã®æœ€å¤§æ–‡å­—æ•°
TOKEN_LEN = 10000

# Gemini APIã®è¨­å®š
genai.configure(api_key=GEMINI_API_KEY)
model = genai.GenerativeModel('models/gemini-1.5-flash')

def get_pr_diff(repo_full_name, pr_number, github_token):
	"""GitHub APIã‹ã‚‰PRã®å·®åˆ†ã‚’å–å¾—ã™ã‚‹"""
	headers = {
		"Authorization": f"token {github_token}",
		"Accept": "application/vnd.github.v3.diff", # diffå½¢å¼ã‚’ç›´æ¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
	}
	url = f"https://api.github.com/repos/{repo_full_name}/pulls/{pr_number}"
	
	print(f"Requesting diff from: {url}")
	diff_response = requests.get(url, headers=headers)
	
	print(f"Diff response status: {diff_response.status_code}")
	diff_response.raise_for_status()
	return diff_response.text

def post_pr_comment(repo_full_name, pr_number, comment_body, github_token):
	"""GitHub APIã‚’ä½¿ã£ã¦PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã™ã‚‹"""
	headers = {
		"Authorization": f"token {github_token}",
		"Accept": "application/vnd.github.v3+json",
	}
	url = f"https://api.github.com/repos/{repo_full_name}/issues/{pr_number}/comments"
	payload = {"body": comment_body}
	response = requests.post(url, headers=headers, data=json.dumps(payload))
	response.raise_for_status()
	print(f"Comment posted successfully to PR #{pr_number}")

def main():
	repo_full_name = os.environ.get("GITHUB_REPOSITORY")
	pr_number = os.environ.get("GITHUB_REF").split('/')[2]

	if not all([repo_full_name, pr_number, GITHUB_TOKEN, GEMINI_API_KEY]):
		print("Error: Required environment variables are missing.")
		exit(1)

	print(f"Processing PR #{pr_number} in {repo_full_name}...")

	try:
		# 1. PRå·®åˆ†ã‚’å–å¾—
		pr_diff = get_pr_diff(repo_full_name, pr_number, GITHUB_TOKEN)
		print("PR diff fetched.")

		if not pr_diff.strip():
			print("Diff is empty. No review needed.")
			# å·®åˆ†ãŒç©ºã®å ´åˆã€ãƒã‚¸ãƒ†ã‚£ãƒ–ãªã‚³ãƒ¡ãƒ³ãƒˆã‚’æ®‹ã—ã¦çµ‚äº†
			comment_body = "ğŸ¤– **Gemini AI Review**: å·®åˆ†ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ä¸è¦ã§ã™ã€‚ãŠç–²ã‚Œæ§˜ã§ã™ï¼"
			post_pr_comment(repo_full_name, pr_number, comment_body, GITHUB_TOKEN)
			exit(0)

		if len(pr_diff) > TOKEN_LEN:
			pr_diff = pr_diff[:TOKEN_LEN] + "\n... (å·®åˆ†ãŒé•·ã™ãã‚‹ãŸã‚çœç•¥ã•ã‚Œã¾ã—ãŸ)"
			print("PR diff truncated.")

		# ### â˜…å¤‰æ›´ç‚¹ 1: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ—¥æœ¬èªåŒ–ã—ã€ã€ŒæŒ‡æ‘˜ãªã—ã€ã®å ´åˆã®ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ  ###
		prompt = f"""
		ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦ã€ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
		ä»¥ä¸‹ã®Pull Requestã®å·®åˆ†ã‚’åˆ†æã—ã€æ¬¡ã®è¦³ç‚¹ã‹ã‚‰å…·ä½“çš„ãªæ”¹å–„ç‚¹ã‚’æŒ‡æ‘˜ã—ã¦ãã ã•ã„ã€‚

		- æ½œåœ¨çš„ãªãƒã‚°ã‚„ã‚¨ãƒ©ãƒ¼
		- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æ”¹å–„ç‚¹
		- å¯èª­æ€§ã‚„ä¿å®ˆæ€§ã®å‘ä¸Š
		- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®æ‡¸å¿µ
		- ã‚ˆã‚Šè‰¯ã„ãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚„è¨­è¨ˆã¸ã®ææ¡ˆ

		ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯ã€ç°¡æ½”ãªç®‡æ¡æ›¸ãã®ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã§ã€æ—¥æœ¬èªã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
		
		**ã€æœ€é‡è¦ãƒ«ãƒ¼ãƒ«ã€‘**
		ã‚‚ã—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ä½•ã‚‚æ‡¸å¿µäº‹é …ã‚„æ”¹å–„ææ¡ˆãŒãªã„å ´åˆã¯ã€ä»–ã®è¨€è‘‰ã¯ä¸€åˆ‡å«ã‚ãšã€ `LGTM` ã¨ã„ã†æ–‡å­—åˆ—ã ã‘ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚

		--- PRã®å·®åˆ† ---
		{pr_diff}
		--- å·®åˆ†ã®çµ‚ã‚ã‚Š ---
		"""

		print("Sending diff to Gemini for review...")
		response = model.generate_content(prompt)
		review_text = response.text.strip()
		print("Review generated by Gemini.")

		# ### â˜…å¤‰æ›´ç‚¹ 2: Geminiã®è¿”ä¿¡å†…å®¹ã«å¿œã˜ã¦æŠ•ç¨¿ã‚³ãƒ¡ãƒ³ãƒˆã‚’åˆ†å² ###
		if review_text == "LGTM":
			# GeminiãŒã€Œå•é¡Œãªã—ã€ã¨åˆ¤æ–­ã—ãŸå ´åˆã®ã‚·ãƒ³ãƒ—ãƒ«ãªã‚³ãƒ¡ãƒ³ãƒˆ
			print("No issues found. Posting a simple LGTM comment.")
			comment_body = "ğŸ¤– **Gemini AI Review**: LGTM! ã‚³ãƒ¼ãƒ‰ã«å•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ç´ æ™´ã‚‰ã—ã„ãŠä»•äº‹ã§ã™ï¼ ğŸ‘"
		else:
			# å…·ä½“çš„ãªæŒ‡æ‘˜ãŒã‚ã£ãŸå ´åˆã®é€šå¸¸ã®ã‚³ãƒ¡ãƒ³ãƒˆ
			print("Issues found. Posting the detailed review.")
			comment_body = f"## ğŸ¤– Gemini AI ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼\n\n{review_text}"
		
		post_pr_comment(repo_full_name, pr_number, comment_body, GITHUB_TOKEN)
		print("Review comment posted.")

	except (ResourceExhausted, GoogleAPICallError) as e:
		print(f"Gemini API Error: {e}")
		print(f"::error::Gemini API Error: {e}")
		exit(1)
	except requests.exceptions.RequestException as e:
		print(f"GitHub API Error: {e}")
		print(f"::error::GitHub API Error: {e}")
		exit(1)
	except Exception as e:
		print(f"An unexpected error occurred: {e}")
		import traceback
		traceback.print_exc()
		print(f"::error::An unexpected error occurred: {e}")
		exit(1)

if __name__ == "__main__":
	main()